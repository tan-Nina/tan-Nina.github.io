<style>
  .ai-demo-container {
    font-family: 'Segoe UI', sans-serif;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    color: #333;
  }

  .demo-section {
    margin-bottom: 40px;
    border-bottom: 2px dashed #ddd;
    padding-bottom: 20px;
  }

  .btn-primary {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }
  .btn-primary:hover {
    background-color: #0056b3;
  }
  .btn-primary:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  /* GAN å¸ƒå±€ */
  .gan-layout {
    display: flex;
    gap: 20px;
    margin-top: 15px;
  }
  .gan-col {
    flex: 1;
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    text-align: center;
  }
  .gan-visual-box {
    height: 150px;
    background: #eee;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    position: relative;
    overflow: hidden;
  }

  /* ç®€å•çš„ CSS åŠ¨ç”»æ¨¡æ‹Ÿç”Ÿæˆå™¨å˜åŒ– */
  .generator-shape {
    width: 20px;
    height: 20px;
    background: red;
    border-radius: 50%;
    transition: all 0.5s ease;
  }

  /* æ‰©æ•£æ¨¡å‹å¸ƒå±€ */
  .diffusion-canvas-wrapper {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
    background: #000;
  }
  canvas#diffusionCanvas {
    width: 100%;
    height: 100%;
  }
</style>

<div class="ai-demo-container">
  <div class="demo-section">
    <h3>ğŸ¤– æ¼”ç¤ºä¸€ï¼šGAN å¯¹æŠ—å¾ªç¯ (Generator vs Discriminator)</h3>
    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¨è¿›è®­ç»ƒï¼Œè§‚å¯Ÿç”Ÿæˆå™¨å¦‚ä½•é€šè¿‡åˆ¤åˆ«å™¨çš„åé¦ˆé€æ¸é€¼è¿‘çœŸå®åˆ†å¸ƒã€‚</p>

    <div style="text-align: center; margin-bottom: 10px;">
      <span id="epoch-display">å½“å‰ Epoch: 0</span>
      <div style="height: 10px; background: #ddd; width: 100%; border-radius: 5px; margin-top: 5px;">
        <div
          id="progress-bar"
          style="height: 100%; background: #28a745; width: 0%; border-radius: 5px; transition: width 0.3s;"
        ></div>
      </div>
    </div>

    <button id="train-btn" class="btn-primary" onclick="nextGanRound()">ä¸‹ä¸€è½®è®­ç»ƒ (Next Epoch)</button>

    <div class="gan-layout">
      <div class="gan-col">
        <h4>ğŸ¨ ç”Ÿæˆå™¨ (Generator)</h4>
        <div class="gan-visual-box" id="g-box">
          <div
            id="g-obj"
            class="generator-shape"
            style="transform: scale(0.5) translate(-50px, 50px); opacity: 0.5;"
          ></div>
        </div>
        <p id="g-status" style="font-size: 12px; color: #666;">çŠ¶æ€: ç”Ÿæˆçº¯å™ªå£°</p>
      </div>

      <div class="gan-col">
        <h4>âš–ï¸ åˆ¤åˆ«å™¨ (Discriminator)</h4>
        <div class="gan-visual-box">
          <div id="d-score" style="font-size: 40px; font-weight: bold; color: #dc3545;">0.99</div>
        </div>
        <p id="d-status" style="font-size: 12px; color: #666;">çŠ¶æ€: è½»æ¾è¯†ç ´å‡å›¾ (Real/Fake å·®å¼‚å·¨å¤§)</p>
      </div>
    </div>
  </div>

  <div class="demo-section" style="border-bottom: none;">
    <h3>ğŸŒ«ï¸ æ¼”ç¤ºäºŒï¼šæ‰©æ•£æ¨¡å‹å»å™ª (Diffusion Denoising)</h3>
    <p>å±•ç¤ºä»çº¯é«˜æ–¯å™ªå£°é€æ­¥è¿˜åŸä¸ºç›®æ ‡å›¾åƒçš„è¿‡ç¨‹ã€‚</p>

    <div style="text-align: center; margin-bottom: 15px;">
      <button class="btn-primary" onclick="startDiffusion()">å¼€å§‹å»å™ª (Start Denoising)</button>
      <button class="btn-primary" style="background-color: #6c757d;" onclick="resetDiffusion()">
        é‡ç½®å™ªå£° (Reset)
      </button>
    </div>

    <div class="diffusion-canvas-wrapper">
      <canvas id="diffusionCanvas" width="300" height="300"></canvas>
    </div>
    <p style="text-align: center; font-size: 12px; color: #888; margin-top: 10px;" id="diffusion-step">
      Step: T=1000 (Pure Noise)
    </p>
  </div>
</div>

<script>
  // --- 1. GAN é€»è¾‘ ---
  let epoch = 0;
  const maxEpochs = 5;
  const gObj = document.getElementById('g-obj');
  const dScore = document.getElementById('d-score');
  const gStatus = document.getElementById('g-status');
  const dStatus = document.getElementById('d-status');
  const progBar = document.getElementById('progress-bar');
  const epochDisplay = document.getElementById('epoch-display');
  const trainBtn = document.getElementById('train-btn');

  // å®šä¹‰æ¯ä¸€è½®çš„çŠ¶æ€ (æ¨¡æ‹Ÿæ•°æ®)
  const ganStates = [
    { scale: 0.5, x: -50, y: 50, op: 0.5, d_val: '0.99', g_text: 'è¾“å‡ºçº¯å™ªå£°', d_text: 'ä¸€çœ¼å‡ï¼šç›´æ¥åˆ¤å®šä¸º Fake' },
    {
      scale: 0.7,
      x: -30,
      y: 20,
      op: 0.6,
      d_val: '0.85',
      g_text: 'å¼€å§‹äº§ç”Ÿè½®å»“',
      d_text: 'ä¸»è¦åˆ¤å®šä¸º Fakeï¼Œä½†æœ‰ä¸€ä¸ç–‘æƒ‘',
    },
    { scale: 0.9, x: -10, y: -10, op: 0.8, d_val: '0.60', g_text: 'çº¹ç†é€æ¸æ¸…æ™°', d_text: 'åˆ¤å®šå˜å¾—å›°éš¾ï¼Œå‡†ç¡®ç‡ä¸‹é™' },
    { scale: 1.0, x: 0, y: 0, op: 1.0, d_val: '0.52', g_text: 'ç”Ÿæˆé€¼çœŸå›¾åƒ', d_text: 'æå…¶å›°æƒ‘ï¼Œæ¥è¿‘ççŒœ (50%)' },
    { scale: 1.0, x: 0, y: 0, op: 1.0, d_val: '0.50', g_text: 'å®Œç¾æ‹ŸåˆçœŸå®åˆ†å¸ƒ', d_text: 'çº³ä»€å‡è¡¡ï¼šæ— æ³•åŒºåˆ†çœŸå‡' },
  ];

  function nextGanRound() {
    if (epoch >= maxEpochs - 1) return;

    epoch++;
    const state = ganStates[epoch];

    // æ›´æ–° UI
    epochDisplay.innerText = `å½“å‰ Epoch: ${epoch}`;
    progBar.style.width = `${(epoch / (maxEpochs - 1)) * 100}%`;

    // æ¨¡æ‹Ÿç”Ÿæˆå™¨å˜åŒ– (CSS Transform)
    gObj.style.transform = `scale(${state.scale}) translate(${state.x}px, ${state.y}px)`;
    gObj.style.opacity = state.op;
    gObj.style.background = epoch === 4 ? '#28a745' : 'red'; // æœ€åå˜æˆç»¿è‰²ä»£è¡¨æˆåŠŸ

    // æ›´æ–°æ–‡æœ¬
    gStatus.innerText = `çŠ¶æ€: ${state.g_text}`;
    dScore.innerText = state.d_val;
    dScore.style.color = epoch > 2 ? '#e0a800' : '#dc3545'; // é¢œè‰²å˜åŒ–
    dStatus.innerText = `çŠ¶æ€: ${state.d_text}`;

    if (epoch === maxEpochs - 1) {
      trainBtn.innerText = 'è®­ç»ƒå®Œæˆ';
      trainBtn.disabled = true;
    }
  }

  // --- 2. æ‰©æ•£æ¨¡å‹é€»è¾‘ ---
  const canvas = document.getElementById('diffusionCanvas');
  const ctx = canvas.getContext('2d');
  let animationId;

  // ç›®æ ‡å›¾åƒ (è¿™é‡Œç”¨ä»£ç ç”»ä¸€ä¸ªç®€å•çš„ç¬‘è„¸ï¼Œé¿å…ä¾èµ–å¤–éƒ¨å›¾ç‰‡é“¾æ¥å¤±æ•ˆ)
  function drawTargetImage(context, opacity) {
    context.save();
    context.globalAlpha = opacity;
    context.fillStyle = '#fff';
    context.fillRect(0, 0, 300, 300);

    // ç”»ä¸€ä¸ªç¬‘è„¸
    context.beginPath();
    context.arc(150, 150, 100, 0, Math.PI * 2, true); // å¤–åœ†
    context.fillStyle = '#FFCC00';
    context.fill();
    context.stroke();

    context.beginPath();
    context.arc(100, 120, 15, 0, Math.PI * 2, true); // å·¦çœ¼
    context.arc(200, 120, 15, 0, Math.PI * 2, true); // å³çœ¼
    context.fillStyle = '#000';
    context.fill();

    context.beginPath();
    context.arc(150, 160, 60, 0, Math.PI, false); // å˜´å·´
    context.stroke();
    context.restore();
  }

  // ç»˜åˆ¶å™ªå£°
  function drawNoise(context, intensity) {
    if (intensity <= 0) return;
    const w = context.canvas.width;
    const h = context.canvas.height;
    const idata = context.createImageData(w, h);
    const buffer32 = new Uint32Array(idata.data.buffer);
    const len = buffer32.length;

    for (let i = 0; i < len; i++) {
      if (Math.random() < intensity) {
        // éšæœºç°åº¦å™ªç‚¹
        const gray = Math.random() * 255;
        // 0xFF000000 æ˜¯ alpha=255, åé¢åŠ ä¸Š RGB
        buffer32[i] = (255 << 24) | (gray << 16) | (gray << 8) | gray;
      }
    }

    // å°†å™ªç‚¹ç»˜åˆ¶åˆ°ä¸´æ—¶ canvas å¹¶å¸¦é€æ˜åº¦å åŠ ï¼Œä¸ºäº†æ€§èƒ½è¿™é‡Œç®€åŒ–ç›´æ¥ç”»
    // è¿™é‡Œæˆ‘ä»¬ç”¨æ›´ç®€å•çš„ globalCompositeOperation å®ç°æ··åˆ
    context.save();
    context.globalAlpha = intensity;
    // æ­¤å¤„å®é™…é€»è¾‘ç®€åŒ–ï¼šç›´æ¥åœ¨åŸå›¾ä¸Šç›–ä¸€å±‚éšæœºåƒç´ æ˜¯ä¸å¤ªå‡†ç¡®çš„æ‰©æ•£ï¼Œ
    // ä½†ä½œä¸ºæ¼”ç¤º "å»å™ª" è§†è§‰æ•ˆæœè¶³å¤Ÿäº†ã€‚
    // æˆ‘ä»¬ç”¨ putImageData ä¼šè¦†ç›–ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„å™ªå£°å±‚
    context.putImageData(idata, 0, 0);
    context.restore();
  }

  // æ›´å¥½çš„æ··åˆç»˜åˆ¶æ–¹æ³•
  let currentStep = 100; // 100 = çº¯å™ªç‚¹, 0 = çº¯å›¾

  function renderDiffusionFrame() {
    // æ¸…ç©º
    ctx.clearRect(0, 0, 300, 300);

    // 1. ç»˜åˆ¶ç›®æ ‡å›¾ (é€æ˜åº¦é€æ¸å¢åŠ )
    const imageOpacity = (100 - currentStep) / 100;
    drawTargetImage(ctx, 1); // å§‹ç»ˆç”»åº•å›¾ï¼Œé ä¸Šé¢çš„å™ªå£°é®ç›–

    // 2. ç»˜åˆ¶å™ªç‚¹å±‚ (é€æ˜åº¦é€æ¸é™ä½)
    const noiseIntensity = currentStep / 100;

    if (noiseIntensity > 0.01) {
      // è·å–å½“å‰ç”»å¸ƒå›¾åƒä½œä¸ºåº•
      // ç”Ÿæˆéšæœºå™ªç‚¹è¦†ç›–
      const w = 300;
      const h = 300;
      const imgData = ctx.getImageData(0, 0, w, h);
      const data = imgData.data;

      for (let i = 0; i < data.length; i += 4) {
        // ç®€å•çš„çº¿æ€§æ’å€¼æ¨¡æ‹Ÿæ‰©æ•£åŠ å™ªè¿‡ç¨‹
        // Pixel = (1-beta)*Origin + beta*Noise
        const noiseVal = Math.random() * 255;

        data[i] = data[i] * (1 - noiseIntensity) + noiseVal * noiseIntensity; // R
        data[i + 1] = data[i + 1] * (1 - noiseIntensity) + noiseVal * noiseIntensity; // G
        data[i + 2] = data[i + 2] * (1 - noiseIntensity) + noiseVal * noiseIntensity; // B
      }
      ctx.putImageData(imgData, 0, 0);
    }

    document.getElementById('diffusion-step').innerText = `Denoising Step: Noise Level ${(noiseIntensity * 100).toFixed(
      0
    )}%`;

    if (currentStep > 0) {
      currentStep -= 0.5; // é€Ÿåº¦
      animationId = requestAnimationFrame(renderDiffusionFrame);
    } else {
      document.getElementById('diffusion-step').innerText = 'ç”Ÿæˆå®Œæ¯• (Generation Complete)';
    }
  }

  function startDiffusion() {
    cancelAnimationFrame(animationId);
    if (currentStep <= 0) currentStep = 100;
    renderDiffusionFrame();
  }

  function resetDiffusion() {
    cancelAnimationFrame(animationId);
    currentStep = 100;
    renderDiffusionFrame(); // ç”»ä¸€å¸§åˆå§‹çŠ¶æ€
  }

  // åˆå§‹åŒ–ç”»ä¸€å¸§
  resetDiffusion();
</script>
